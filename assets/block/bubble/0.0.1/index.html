<div><div plug="layout"><div class="pdl-layout"><div data-type="layout"><div class="pdl-cell" data-name="view"></div><div class="pdl-cell" data-name="unit"></div><div class="pdl-cell" data-name="legend"></div></div><div data-type="render"></div></div></div><style type="text/css">.pdl-layout>div[data-type=layout]{display:grid;grid-template-columns:1fr fit-content(10em);grid-template-rows:1fr fit-content(1em)}.pdl-layout>div[data-type=layout]>.pdl-cell[data-name=view]{grid-area:1/1}.pdl-layout>div[data-type=layout]>.pdl-cell[data-name=legend]{grid-column:2;grid-row:1/span 2;padding:0 .5em 0 .5em}.pdl-layout>div[data-type=layout]>.pdl-cell[data-name=unit]{grid-column:1;grid-row:2;line-height:1em;text-align:right;padding:.25em 0}.pdl-layout.legend-bottom>div[data-type=layout]{grid-template-columns:1fr fit-content(1em);grid-template-rows:1fr fit-content(3em)}.pdl-layout.legend-bottom>div[data-type=layout] .pdl-cell[data-name=view]{grid-column:1/span 2;grid-row:1}.pdl-layout.legend-bottom>div[data-type=layout] .pdl-cell[data-name=legend]{padding-top:1em;grid-column:1;grid-row:2}.pdl-layout.legend-bottom>div[data-type=layout] .pdl-cell[data-name=unit]{padding-top:1em;grid-column:2;grid-row:2}</style><script type="@plotdb/block">var mod;module.exports={pkg:{name:"bubble",version:"0.0.1",extend:{name:"base",version:"0.0.1"},dependencies:[],i18n:{"zh-TW":{K:"千",M:"百萬"}}},init:function(t){var e,r,n,i;e=t.root,r=t.ctx,n=t.pubsub,i=t.t;return n.fire("init",{mod:mod({ctx:r,t:i})}).then(function(t){return t[0]})}};mod=function(t){var e,r,d,a,h,n,i;e=t.ctx,r=t.t;d=e.d3,a=e.forceBoundary,h=e.ldcolor,n=e.chart;return{sample:function(){return{raw:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100].map(function(t){return{name:"N-"+t,val1:(Math.random()*100).toFixed(1),val2:(Math.random()*100).toFixed(1),val3:(Math.random()*100).toFixed(1),cat:Math.floor(Math.random()*6)}}),binding:{group:{key:"cat"},name:{key:"name"},color:{key:"cat"},area:[{key:"val1"}]}}},config:(i=import$({},n.utils.config.preset["default"]),i.legend=n.utils.config.preset.legend,i.tip={enabled:{type:"boolean",default:true}},i.pie={order:{type:"choice",values:["group","ratio"],default:"ratio"},color:{type:"choice",name:"colorscheme",values:["from palette","by lightness"],default:"by lightness"}},i.label={enabled:{type:"choice",default:"both",values:["both","name","value"]},format:{type:"text",default:".3s"}},i.tip={enabled:{type:"boolean",default:true}},i),dimension:{group:{type:"C",name:"group",priority:2},color:{type:"NR",name:"color",priority:4},area:{type:"R",name:"area",priority:1,multiple:true},name:{type:"NC",name:"name",priority:3}},init:function(){var u,t,e,s=this;this.tint=u=new n.utils.tint;this.parsed=this.parsed||[];this.g=Object.fromEntries(["view","unit","legend"].map(function(t){return[t,d.select(s.layout.getGroup(t))]}));t=this.root.querySelector("[ld=tip]");this.tip=new n.utils.tip({root:this.root,accessor:function(t){var e,r,n,i;e=t.evt;if(!(e.target&&(r=d.select(e.target).datum()))){return null}n=!(i=s.fmt(r.area))?"":i+""+(s.binding.area.unit||"");return{name:r.name,value:n}},range:function(){return s.layout.getNode("view").getBoundingClientRect()}});this.legend=new n.utils.legend({layout:this.layout,name:"legend",root:this.root,shape:function(t){return d.select(this).attr("fill",u.get(t.key))},direction:((e=this.cfg).legend||(e.legend={})).position==="bottom"?"horizontal":"vertical",cfg:{selectable:true}});this.legend.on("select",function(){s.bind();s.resize();return s.render()});this.arc=d.arc().startAngle(0).endAngle(Math.PI/2);return this._color=function(t,e){var r,n,i,a,o;r=s.groups.length?t.group:"";n=s.groups.length&&s.cfg.pie.color==="by lightness"||e===0?(t.color||(r!=null?r:""))+"":(t.color||(r!=null?r:""))+"/"+e;n=u.get(n);if(s.groups.length&&s.cfg.pie.color==="by lightness"){i=h.hcl(n);a=e/(t.paths.length||1);o=i.l>=80?i.l-(i.l-10)*a:i.l+(90-i.l)*a;n=i.c>=90?i.c:i.c+(90-i.c)*a;i.c=n;i.l=o;return h.web(i)}else{return h.web(n)}}},destroy:function(){return this.tip.destroy()},parse:function(){var t;this.tint.reset();this.data.map(function(t){return t._area=t.area});this.valid=this.data.filter(function(t){return Array.isArray(t.area)&&!isNaN(t.area.reduce(function(t,e){return t+e},0))});this.groups=Array.from(new Set(this.valid.map(function(t){return t.group}))).filter(function(t){return t!=null});this.sim=null;t=this.groups.map(function(t){return{key:t,text:t}});t.sort(function(t,e){if(t.key>e.key){return 1}else if(t.key<e.key){return-1}else{return 0}});if(!t.length){t=(this.binding.area||[]).map(function(t,e){return{key:e?"/"+e:"",text:t.name||t.key}})}return this.legend.data(t)},resize:function(){var e,t,r,n,i,a,o,u,s,l,c,h,f=this;try{this.fmt=d.format(this.cfg.label.format)||".3s"}catch(t){e=t;this.fmt=function(t){return t}}this.root.querySelector(".pdl-layout").classList.toggle("legend-bottom",((t=this.cfg).legend||(t.legend={})).position==="bottom");this.tip.toggle(this.cfg.tip.enabled!=null?this.cfg.tip.enabled:true);this.random=d.randomUniform.source(d.randomLcg(+Date.now()))(0,1);r=[{key:"root",root:true}].concat(this.groups.map(function(t){return{key:"group-"+t}}),!this.groups.length?this.valid:this.valid.filter(function(t){return!f.cfg.legend.enabled||f.legend.isSelected(t.group)}));if(this.legend.enabled()){r=r.filter(function(t){return!t._raw||!f.groups.length||f.legend.isSelected(t.group)})}this.legend.config(this.cfg.legend);this.legend.update();this.layout.update(false);if(!this.groups.length){n=(this.binding.area||[]).map(function(t,e){return f.legend.isSelected(e?"/"+e:"")});r.map(function(t){if(Array.isArray(t._area)){return t.area=t._area.map(function(t,e){if(n[e]){return t}else{return 0}})}})}i=d.hierarchy(d.stratify().id(function(t){if(t._idx!=null){return t._idx}else{return t.key}}).parentId(function(t){var e;if(t.root){return""}else if((e=t.group)!=null){return"group-"+e}else{return"root"}})(r)).sum(function(t){return(t.data.area||[]).reduce(function(t,e){return t+e},0)}).sort(function(t,e){return e.value-t.value});a=this.vbox=this.layout.getBox("view");o=d.pack().size([a.width,a.height])(i);this.parsed=i.leaves().map(function(i){var e,a,t,r,n,o,u,s,l,c;i._raw=i.data.data._raw;e=i.data.data;a=f.parsed?(t=f.parsed.filter(function(t){if(t.name!=null||e.name!=null){return t.name===e.name}else{return t._idx===e._idx}})[0],t?t:i):i;r=i.x,n=i.y;i.radius=Math.pow(e.area,.5);i.x=r;i.y=n;i._idx=e._idx;i.name=e.name;i.color=e.color;i.group=e.group;i.area=e.area;if(a._x){i._x=a._x}else if(!i._x){i._x=i.x}if(a._y){i._y=a._y}else if(!i._y){i._y=i.y}i.paths=(i.area||[]).map(function(t,e){var r,n;return n={name:i.name,group:i.group,area:t},n.old=(r=(a.paths||[])[e]||{}).old,n.cur=r.cur,n});o=0;u=i.paths.length>1?(i.paths[0].area-i.paths[1].area)/4:0;for(s=0,l=i.paths.length;s<l;++s){c=s;i.paths[c].s=o-u;i.paths[c].e=(o+=i.paths[c].area)-u}i.rate=u;i.total=o||1;return i}).filter(function(t){return t.area!=null&&!isNaN(t.x)&&!isNaN(t.y)});u={};this.parsed.map(function(t,e){var r,n,i,a;(r=u[i=t.group]||(u[i]={})).x1<=(n=t.x)||(r.x1=n);(r=u[i=t.group]||(u[i]={})).x2>=(n=t.x)||(r.x2=n);(r=u[i=t.group]||(u[i]={})).y1<=(n=t.y)||(r.y1=n);return(a=(r=u[i=t.group]||(u[i]={})).y2)>=(n=t.y)?a:r.y2=n});s={};l=this.parsed.filter(function(t){return t.paths.length>1}).map(function(t){return t._dr=(t.paths[0].area-t.paths[1].area)/(t.paths[0].area+t.paths[1].area||1)});s.x1=Math.min.apply(Math,l);s.x2=Math.max.apply(Math,l);c=s.x2-s.x1||1;h=(s.x2+s.x1)/2;this.parsed.map(function(t,e){var r,n;if(t.paths.length<=1){return}r=(t._dr-h)*2/c;n=u[t.group];if(f.cfg.pie.order==="group"){return t.x=r*(n.x2-n.x1)*.5+(n.x2+n.x1)/2,t}else{return t.x=r*a.width*.4+a.width*.5,t}});this.sim=null;return this.start()},render:function(){var a,o,n,u,t,e,r,i,s,l,c=this;a=this.fmt,o=this._color,n=this.cfg,u=this.binding,t=this.tint;e=this.vbox;this.rate=r=.85*Math.PI/(2*Math.sqrt(3))*Math.sqrt(e.width*e.height/this.parsed.map(function(t){return Math.PI*Math.pow(t.r,2)}).reduce(function(t,e){return t+e},0));this.parsed.map(function(t,e){var r;return t.rr=(r=t.r*c.rate)>2?r:2});this.parsed.map(function(i,t){return i.paths.map(function(t,e){var r,n;r=t.s*2*Math.PI/i.total;n=t.e*2*Math.PI/i.total;t.old=t.cur||{r:i.rr,s:r,e:n};return t.cur={r:i.rr,s:r,e:n}})});t.set(this.cfg.palette);i=function(i,a,t){return function(e){var t,r,n;c.arc.innerRadius(0).outerRadius((a.r-i.r)*e+i.r);t=["s","e"].map(function(t){return(a[t]-i[t])*e+i[t]}),r=t[0],n=t[1];c.arc.startAngle(r).endAngle(n);return c.arc()}};s=this.g.view.selectAll("g.bubble").data(this.parsed,function(t){return t.name||t._idx});s.exit().remove();s.enter().append("g").attr("class","bubble").attr("transform",function(t,e){return"translate("+t._x+","+t._y+")"});this.g.view.selectAll("g.bubble").attr("transform",function(t,e){return"translate("+t._x+","+t._y+")"}).each(function(r,t){var e,n;e=d.select(this);n=e.selectAll("path.data").data(r.paths,function(t,e){return e});n.exit().remove();n.enter().append("path").attr("class","data").attr("opacity",function(t,e){return 0}).attr("fill",function(t,e){return o(r,e)});return e.selectAll("path.data").transition().duration(350).attrTween("d",function(t,e){return i(t.old,t.cur,e)}).attr("fill",function(t,e){return o(r,e)}).attr("opacity",1)});l=this.g.view.selectAll("g.label").data(this.parsed,function(t){return t.name||t._idx});l.exit().remove();l.enter().append("g").attr("class","label data").attr("transform",function(t,e){return"translate("+t.x+","+t.y+")"}).attr("opacity",0).attr("font-size",function(){return n.font.size}).style("pointer-events","none").style("cursor","pointer").each(function(t,e){var r=this;return[0,1].map(function(){return d.select(r).append("text")}).map(function(t){return t.attr("dy","0").attr("opacity",0).attr("text-anchor","middle").style("pointer-event","none")})});this.g.view.selectAll("g.label").attr("transform",function(t,e){return"translate("+t._x+","+t._y+")"}).each(function(i,t){return d.select(this).selectAll("text").text(function(t,e){var r,n;if(e!==0){return i.name||""}r=i.area.reduce(function(t,e){return t+e},0);if(!(n=a(r))){return""}else{return n+""+(u.area.unit||"")}}).attr("font-size",function(t,e){return e?"0.9em":"1.1em"}).transition().duration(350).attr("dy",function(t,e){if(n.label.enabled!=="both"){return".28em"}if(e===0){return"-.28em"}else{return".88em"}}).attr("opacity",function(t,e){var r;r=n.label.enabled;if(r==="both"){return 1}if(r==="name"){return e===0?0:1}if(r==="value"){return e===1?0:1}return 1}).attr("fill",function(){var t;t=h.hcl(o(i,0));if(t.l<70){return"#fff"}else{return"#000"}})});this.g.view.selectAll("g.label").transition().duration(150).attr("font-size",function(){return n.font.size});if(this.h){clearTimeout(this.h)}this.h=setTimeout(function(){c.h=null;return c.g.view.selectAll("g.label").transition().duration(150).attr("opacity",function(t,e){var r,n,i,a;r=this.getBoundingClientRect();n=[r.width,r.height],i=n[0],a=n[1];if(2*t.rr<i||2*t.rr<a){return 0}else{return 1}})},150);return this.legend.render()},tick:function(){var e,r,t,n,i=this;e=this.cfg.pad||5;r=this.vbox;if(!this.sim){t=true;this.fc=n=d.forceCollide().strength(.5).iterations(20).radius(function(t){return i.rate*t.r});this.fg=d.forceCenter().strength(.5);this.fb=a(function(t){return t.rr+e},function(t){return t.rr+e},function(t){return r.width-t.rr-e},function(t){return r.height-t.rr-e}).strength(.5);this.sim=d.forceSimulation().force("b",this.fb).force("collide",this.fc);this.sim.stop();this.sim.alpha(.9)}this.fg.x(r.width/2);this.fg.y(r.height/2);this.sim.nodes(this.parsed);this.sim.tick(t?10:1);this.parsed.map(function(t){t._x=t._x+(t.x-t._x)*.1;return t._y=t._y+(t.y-t._y)*.1});this.g.view.selectAll("g.bubble").attr("transform",function(t,e){return"translate("+t._x+","+t._y+")"});return this.g.view.selectAll("g.label").attr("transform",function(t,e){return"translate("+t._x+","+t._y+")"})}}};function import$(t,e){var r={}.hasOwnProperty;for(var n in e)if(r.call(e,n))t[n]=e[n];return t}</script></div>